{% extends "student_app/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2>Student Management</h2>
    <p class="text-muted">Welcome, <strong>{{ username }}</strong>! (From Session)</p>
  </div>
  <div>
    <a href="{% url 'logout' %}" class="btn btn-outline-secondary btn-sm">Logout</a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <a href="{% url 'student_add' %}" class="btn btn-primary w-100">Add New Student</a>
      </div>
      
      <div class="col-md-8">
        <form method="get" action="{% url 'student_list' %}" class="d-flex">
          <input type="text" name="search" class="form-control me-2" placeholder="Search students..." value="{{ search_query }}">
          <input type="hidden" name="sort_by" value="{{ current_sort }}">
          <button type="submit" class="btn btn-outline-primary">Search</button>
        </form>
      </div>
    </div>
  </div>
</div>

<h3 class="h5">Student Records</h3>
<p class="text-muted"><small>Your last sort preference (<strong>{{ current_sort|cut:"-"|title }}</strong>) is saved in a cookie.</small></p>
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead class="table-light">
      <tr>
        {% with sort_field=current_sort|cut:"-" %}
        <th>
          <a href="?sort_by={% if sort_field == 'last_name' and current_sort.0 != '-' %}-{% endif %}last_name&search={{ search_query }}"
             class="{% if sort_field == 'last_name' %}active {% if current_sort.0 == '-' %}desc{% else %}asc{% endif %}{% endif %}">
            Last Name
          </a>
        </th>
        <th>
          <a href="?sort_by={% if sort_field == 'first_name' and current_sort.0 != '-' %}-{% endif %}first_name&search={{ search_query }}"
             class="{% if sort_field == 'first_name' %}active {% if current_sort.0 == '-' %}desc{% else %}asc{% endif %}{% endif %}">
            First Name
          </a>
        </th>
        <th>
          <a href="?sort_by={% if sort_field == 'roll_number' and current_sort.0 != '-' %}-{% endif %}roll_number&search={{ search_query }}"
             class="{% if sort_field == 'roll_number' %}active {% if current_sort.0 == '-' %}desc{% else %}asc{% endif %}{% endif %}">
            Roll Number
          </a>
        </th>
        <th>
          <a href="?sort_by={% if sort_field == 'grade' and current_sort.0 != '-' %}-{% endif %}grade&search={{ search_query }}"
             class="{% if sort_field == 'grade' %}active {% if current_sort.0 == '-' %}desc{% else %}asc{% endif %}{% endif %}">
            Grade
          </a>
        </th>
        <th>
          <a href="?sort_by={% if sort_field == 'major' and current_sort.0 != '-' %}-{% endif %}major&search={{ search_query }}"
             class="{% if sort_field == 'major' %}active {% if current_sort.0 == '-' %}desc{% else %}asc{% endif %}{% endif %}">
            Major
          </a>
        </th>
        {% endwith %}
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for student in students %}
      <tr>
        <td>{{ student.last_name }}</td>
        <td>{{ student.first_name }}</td>
        <td>{{ student.roll_number }}</td>
        <td>{{ student.grade }}</td>
        <td>{{ student.major|default:"N/A" }}</td>
        <td>
          <a href="{% url 'student_update' student.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
          
          <form action="{% url 'student_delete' student.pk %}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete {{ student.first_name }}?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted">No students found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}